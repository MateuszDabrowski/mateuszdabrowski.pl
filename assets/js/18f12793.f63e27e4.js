"use strict";(self.webpackChunkmd=self.webpackChunkmd||[]).push([[4799],{4137:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function r(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},c=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),h=u(n),m=i,p=h["".concat(s,".").concat(m)]||h[m]||d[m]||o;return n?a.createElement(p,l(l({ref:t},c),{},{components:n})):a.createElement(p,l({ref:t},c))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,l=new Array(o);l[0]=h;var r={};for(var s in t)hasOwnProperty.call(t,s)&&(r[s]=t[s]);r.originalType=e,r.mdxType="string"==typeof e?e:i,l[1]=r;for(var u=2;u<o;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},1872:(e,t,n)=>{n.d(t,{m:()=>o});var a=n(7294);const i="leadText_qzwo",o=e=>{let{content:t}=e;return a.createElement(a.Fragment,null,a.createElement("p",{id:i},t))}},1944:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>u,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var a=n(7462),i=(n(7294),n(4137)),o=n(1872);const l={id:"sfmc-sql-debugging-value-length",title:"SFMC SQL Debugging Value Length",sidebar_label:"Debugging Value Length",description:"Your Automations crash due to longer than expected values coming from the external source? Make your life easier with SQL.",image:"img/og/og-image-sql-debugging-value-length.png",tags:["Marketing Cloud","SQL","Snippet","Data Extensions","Debugging","Automation"]},r=void 0,s={unversionedId:"sql/snippets/sfmc-sql-debugging-value-length",id:"sql/snippets/sfmc-sql-debugging-value-length",title:"SFMC SQL Debugging Value Length",description:"Your Automations crash due to longer than expected values coming from the external source? Make your life easier with SQL.",source:"@site/docs/sql/snippets/sfmc-sql-debugging-value-length.mdx",sourceDirName:"sql/snippets",slug:"/sql/snippets/sfmc-sql-debugging-value-length",permalink:"/docs/sql/snippets/sfmc-sql-debugging-value-length",draft:!1,editUrl:"https://github.com/MateuszDabrowski/mateuszdabrowski.pl/edit/master/docs/sql/snippets/sfmc-sql-debugging-value-length.mdx",tags:[{label:"Marketing Cloud",permalink:"/docs/tags/marketing-cloud"},{label:"SQL",permalink:"/docs/tags/sql"},{label:"Snippet",permalink:"/docs/tags/snippet"},{label:"Data Extensions",permalink:"/docs/tags/data-extensions"},{label:"Debugging",permalink:"/docs/tags/debugging"},{label:"Automation",permalink:"/docs/tags/automation"}],version:"current",lastUpdatedBy:"Mateusz D\u0105browski",lastUpdatedAt:1672049341,formattedLastUpdatedAt:"Dec 26, 2022",frontMatter:{id:"sfmc-sql-debugging-value-length",title:"SFMC SQL Debugging Value Length",sidebar_label:"Debugging Value Length",description:"Your Automations crash due to longer than expected values coming from the external source? Make your life easier with SQL.",image:"img/og/og-image-sql-debugging-value-length.png",tags:["Marketing Cloud","SQL","Snippet","Data Extensions","Debugging","Automation"]},sidebar:"snippets",previous:{title:"Debugging Email Sends",permalink:"/docs/sql/snippets/sfmc-sql-debugging-email-sends"}},u={},c=[{value:"Problem with recommended Data Extension total field length",id:"problem-with-recommended-data-extension-total-field-length",level:2},{value:"Short Term Solution",id:"short-term-solution",level:2},{value:"Discovery with MAX LEN",id:"discovery-with-max-len",level:3},{value:"Debugging with MAX LEN",id:"debugging-with-max-len",level:3},{value:"Basic Long Term Solution",id:"basic-long-term-solution",level:2},{value:"Options",id:"options",level:2},{value:"Show fields with too long value",id:"show-fields-with-too-long-value",level:3},{value:"Extended length information",id:"extended-length-information",level:3},{value:"Fully-fledged Long Term Solution",id:"fully-fledged-long-term-solution",level:2}],d={toc:c};function h(e){let{components:t,...n}=e;return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)(o.m,{content:"Your Automations crash due to longer than expected values coming from the external source? Make your life easier with SQL.",mdxType:"LeadText"}),(0,i.kt)("h2",{id:"problem-with-recommended-data-extension-total-field-length"},"Problem with recommended Data Extension total field length"),(0,i.kt)("p",null,"Working with Marketing Cloud (or any other Marketing Automation Platform) is always the dance between optimisation and flexibility. It is easily visible when working with SFMC Data Extensions."),(0,i.kt)("p",null,"On the one hand, limiting the maximum field length is a must-have best practice. Salesforce recommends keeping the total sum of all fields length under 4000 characters. For many use cases, a tiny number. But if you want to have lean Data Extensions to query them quickly, it is the way. And in the Marketing Cloud, nearly everything is a query - even if you don't write a line of SQL."),(0,i.kt)("p",null,"On the other hand, it might be tough to limit your Data Extension so much in real-life scenarios. Especially when you are bringing data from other systems. Example? Salesforce CRM integration through Marketing Cloud Connect. The picklist fields from CRM come to Synchronized Data Extensions as 255 character text fields - even if they have only one-digit values associated with it. Select a few such picklists to be available in Marketing Cloud, and you hit the Data Extension character length limit recommended by Salesforce."),(0,i.kt)("p",null,"What to do with that?"),(0,i.kt)("p",null,"Limit the maximum length of those picklists in the Marketing Cloud Data Extension you use for campaigns. You are sure that your Gender field will always have one character value (",(0,i.kt)("inlineCode",{parentName:"p"},"F"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"M"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"O"),"/",(0,i.kt)("inlineCode",{parentName:"p"},"U"),")? Make the maximum length equal to 1. It is an excellent way to trim unneeded length, but sometimes, you might be surprised, especially with less obvious picklists, like a job title. Similar issues might also come from standard text fields."),(0,i.kt)("p",null,"Once you build your standard Data Extension with those optimisations in mind, it is time to pull the data from Synchronized Data Extensions."),(0,i.kt)("admonition",{title:"You Should Know",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"I'm mentioning the Marketing Cloud Connect Synchronized Data Extensions, but you can also leverage it for FTP-based data uploads. The solution will require additional intermediate Data Extension with generous field lengths in place of Marketing Cloud Connect Synchronized Data Extension. Rest will be the same.")),(0,i.kt)("p",null,"All good, until one of the values, exceed the maximum length you set for its field. The Automation crashes with a cryptic error that tells you nothing and can push you for a long crusade to find the culprit. What now?"),(0,i.kt)("h2",{id:"short-term-solution"},"Short Term Solution"),(0,i.kt)("p",null,"You can make quick manual check with a simple SQL query. Open your ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-basics#query-studio"},"Query Studio")," and copy-paste the below code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Sample maximum length checking query on Contact object Synchronized Data Extension"',title:'"Sample',maximum:!0,length:!0,checking:!0,query:!0,on:!0,Contact:!0,object:!0,Synchronized:!0,Data:!0,'Extension"':!0},"SELECT\n      MAX(LEN(c.Id))          AS SubscriberKey\n    , MAX(LEN(c.FirstName))   AS FirstName\n    , MAX(LEN(c.LastName))    AS LastName\n    , MAX(LEN(c.Email))       AS EmailAddress\n    , MAX(LEN(c.JobTitle__c)) AS CurrentRole\n    , MAX(LEN(c.Industry__c)) AS Industry\nFROM Contact_Salesforce AS c\n")),(0,i.kt)("admonition",{title:"You Should Know",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"If you are running those queries from the child Business Unit, add ",(0,i.kt)("inlineCode",{parentName:"p"},"Ent.")," prefix to Synchronized Data Extension names, as those are stored on the parent level.")),(0,i.kt)("p",null,"This query will output one row of data with the current maximum length of the values that you have in your Synchronized Data Extension for the selected fields. It uses ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-numeric-functions#min-and-max"},(0,i.kt)("inlineCode",{parentName:"a"},"MAX"))," function on the ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-string-functions#len"},(0,i.kt)("inlineCode",{parentName:"a"},"LEN"))," outcome to find the single maximum length available across all records. It has two great uses:"),(0,i.kt)("h3",{id:"discovery-with-max-len"},"Discovery with MAX LEN"),(0,i.kt)("p",null,"You can use it even before configuring the Data Extension and Profile Attributes to analyse your real-life data."),(0,i.kt)("p",null,"For example, if out of your whole database, the longest First Name is 33 characters, you will probably be just fine with a maximum length of 40 on this field. If a picklist field returns you 5 with this query - you won't need the default 255 characters."),(0,i.kt)("p",null,"Of course, as mentioned above, the values might get longer in the future. But as Marketing Cloud allows you to change maximum field length up but not down, it might be a good idea to try as low as reasonable and leave space for growth."),(0,i.kt)("h3",{id:"debugging-with-max-len"},"Debugging with MAX LEN"),(0,i.kt)("p",null,"The second use of the above snippet is quick debugging when an error occurs. Execute it in ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-basics#query-studio"},"Query Studio")," and compare against the column lengths you set up in your Data Extension. If you see in Query Studio any value longer than the maximum you set up in Data Extension - you found a culprit."),(0,i.kt)("p",null,"Now you can look in the data source and check whether this longer-than-expected value is correct. If yes, it is time to update your maximum length in the Data Extension and Profile Attribute configuration."),(0,i.kt)("admonition",{title:"You Should Know",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"In most cases, the field length of 255 should be more than enough. But if you need it, Marketing Cloud allows you to go up to 4000 characters per field."),(0,i.kt)("p",{parentName:"admonition"},"4000 characters length is an instant way of getting over the recommended limit, but it might be useful for logging Data Extensions that you won't query in the future. For example, if you want to save ",(0,i.kt)("a",{parentName:"p",href:"/docs/config/sfmc-system-data-views#_bounce"},(0,i.kt)("inlineCode",{parentName:"a"},"_Bounce")," Data View")," to standard Data Extension, ",(0,i.kt)("inlineCode",{parentName:"p"},"SMTPBounceReason")," might use such a long field."),(0,i.kt)("p",{parentName:"admonition"},"If you need more, there is a trick reported by ",(0,i.kt)("a",{parentName:"p",href:"https://salesforce.stackexchange.com/questions/154402/data-extension-maximum-characters-of-text-field/154403"},"Markus Slabina"),". Use Email Studio to add a new field and make the length empty. Save. It will create a ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-conversion-functions#data-types"},(0,i.kt)("inlineCode",{parentName:"a"},"nvarchar(max)"))," field that allows absurdly long data to be stored."),(0,i.kt)("p",{parentName:"admonition"},"Remember that:"),(0,i.kt)("ol",{parentName:"admonition"},(0,i.kt)("li",{parentName:"ol"},"It works only in Email Studio - Contact Builder won't work"),(0,i.kt)("li",{parentName:"ol"},"It is a workaround and might disappear at any moment"),(0,i.kt)("li",{parentName:"ol"},"You shouldn't use it unless there is no other option"))),(0,i.kt)("h2",{id:"basic-long-term-solution"},"Basic Long Term Solution"),(0,i.kt)("p",null,"The snippet above is nice but suitable only for short term manual checks. And you don't want to perform manual checks for the long term. If you wonder whether there is a way to automate it nicely, you are here for a treat."),(0,i.kt)("p",null,"Yes, you can automate such validation by using two additional Activities."),(0,i.kt)("p",null,"Go to the Automation that takes care of moving the data from Synchronized Data Extension do Standard Data Extension and Profile Attributes. Before the Activities that are transfering the data, add a SQL Query Activity. In it, paste the below code:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Basic field length checking query"',title:'"Basic',field:!0,length:!0,checking:!0,'query"':!0},"SELECT\n      c.Id               AS ContactID\n    , LEN(c.Id)          AS SubscriberKey\n    , LEN(c.FirstName)   AS FirstName\n    , LEN(c.LastName)    AS LastName\n    , LEN(c.Email)       AS EmailAddress\n    , LEN(c.JobTitle__c) AS JobTitle\n    , LEN(c.Industry__c) AS Industry\nFROM Contact_Salesforce AS c\nWHERE\n    18 - LEN(c.Id) < 0\n    OR 40 - LEN(c.FirstName) < 0\n    OR 80 - LEN(c.LastName) < 0\n    OR 254 - LEN(c.Email) < 0\n    OR 80 - LEN(c.JobTitle__c) < 0\n    OR 40 - LEN(c.Industry__c) < 0\n")),(0,i.kt)("p",null,"Of course, you will want to adapt it to your needs. Change the fields along with their names and lengths. Select the right Synchronized Data Extension. How? Let's dive in what this code does so that you can make it your own."),(0,i.kt)("p",null,"The first field we ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-select"},(0,i.kt)("inlineCode",{parentName:"a"},"SELECT"))," is the Unique Identifier (Contact ID / Subscriber Key or other based on the specific object you are validating). It is useful to quickly know which record(s) should you checked when some values lengths exceed the expectations."),(0,i.kt)("p",null,"After that, you can see the standard ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-from"},(0,i.kt)("inlineCode",{parentName:"a"},"FROM"))," statement. You can, of course, ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-join"},(0,i.kt)("inlineCode",{parentName:"a"},"JOIN"))," additional data sources."),(0,i.kt)("p",null,"Finally, there is a ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-where"},(0,i.kt)("inlineCode",{parentName:"a"},"WHERE"))," statement. In it, we are checking whether at least one field on each record has a value longer than expected. To adapt it - change the number on the left to the length of the field you set up in the target Data Extension / Profile Attribute."),(0,i.kt)("p",null,"This SQL Query Activity should output the rows to a technical Value Length Data Extension with all the same columns as the target Data Extension / Profile Attributes list. However, it can have much shorter max lengths for the columns, as all fields but the Unique Identifier one will output only the field's length (up to 4 digits). Configure the SQL Activity to Overwrite the technical Data Extension and always have the latest state data."),(0,i.kt)("p",null,"Right after this SQL Query Activity add Verification Activity and configure it to check the technical Data Extension mentioned above. If there is any row in it - it should stop the whole Automation and send an alert email to the Marketing Cloud administrator."),(0,i.kt)("p",null,"To sum up, sample Automation could look like this:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"SQL Query Activity with the Debugging Value Length query"),(0,i.kt)("li",{parentName:"ol"},"Verification Activity that checks Value Length Data Extension"),(0,i.kt)("li",{parentName:"ol"},"SQL Query Activity that moves data from Synchronized Data Extension to target Data Extension"),(0,i.kt)("li",{parentName:"ol"},"Export Activity"),(0,i.kt)("li",{parentName:"ol"},"Transfer Activity"),(0,i.kt)("li",{parentName:"ol"},"Import Activity")),(0,i.kt)("p",null,"The last three Activities above are the classic ETL group for updating the All Subscribers and Profile Attributes."),(0,i.kt)("p",null,"Such setup won't silently crash your Automation whenever there is a single value longer than expected. It will stop the Automation before the crash, inform the administrator that there is an issue and provide Unique Identifiers of records leading to that error for an easy check. Neat, right? Well, it can be even better."),(0,i.kt)("h2",{id:"options"},"Options"),(0,i.kt)("p",null,"The basic version above is already lovely, but we can make a few improvements to make the administrator's life even easier."),(0,i.kt)("h3",{id:"show-fields-with-too-long-value"},"Show fields with too long value"),(0,i.kt)("p",null,"Previously shown query will show the problematic record, but it will display all field lengths for it. The administrator will still have to compare the lengths to find which one is the issue's source."),(0,i.kt)("p",null,"However, we already are coding the expected field length in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-from"},(0,i.kt)("inlineCode",{parentName:"a"},"FROM"))," part of the query. Why not use it to make life easier?"),(0,i.kt)("p",null,"Let's change the ",(0,i.kt)("inlineCode",{parentName:"p"},"LEN(c.Id) AS [Subscriber Key],")," in the ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-select"},(0,i.kt)("inlineCode",{parentName:"a"},"SELECT"))," statement part to something a bit more interesting:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'title="Use CASE to display only the problematic fields"',title:'"Use',CASE:!0,to:!0,display:!0,only:!0,the:!0,problematic:!0,'fields"':!0},"CASE\n    WHEN 18 - LEN(c.Id) < 0\n    THEN LEN(c.Id)\nEND AS SubscriberKey\n")),(0,i.kt)("p",null,"As you can see, we changed a simple line to a more complex ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-case#conditional-values-with-case"},(0,i.kt)("inlineCode",{parentName:"a"},"CASE"))," statement. There is a good reason for it. Thanks to it, the query will evaluate each field against the expected length and in the Value Length Data Extension display information only for the problematic values."),(0,i.kt)("p",null,"The administrator will no longer have to compare each field with configured maximum - he will see it directly in the Data Extension, which saves time and limits the errors."),(0,i.kt)("h3",{id:"extended-length-information"},"Extended length information"),(0,i.kt)("p",null,"We can go even further with this approach and add a bit more data to the output for those problematic fields by making few calculations in ",(0,i.kt)("inlineCode",{parentName:"p"},"THEN")," part of the ",(0,i.kt)("a",{parentName:"p",href:"/docs/sql/sfmc-sql-case#conditional-values-with-case"},(0,i.kt)("inlineCode",{parentName:"a"},"CASE"))," statement."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql",metastring:'{3} title="Let the code do the work"',"{3}":!0,title:'"Let',the:!0,code:!0,do:!0,'work"':!0},"CASE\n    WHEN 18 - LEN(c.Id) < 0\n    THEN CONCAT(LEN(c.Id), '(', LEN(c.Id) - 18, ' over limit)')\nEND AS SubscriberKey\n")),(0,i.kt)("p",null,"Here, apart from the problematic field's length, we are also showing how much it exceeds the current configuration."),(0,i.kt)("p",null,"For example, if we expect the First Name to be under 40 characters and one record comes with 46 characters, the previous solution would output ",(0,i.kt)("inlineCode",{parentName:"p"},"46"),". This extended one will be a bit more verbose by showing ",(0,i.kt)("inlineCode",{parentName:"p"},"46 (6 over limit)"),"."),(0,i.kt)("p",null,"Remember that if you implement this option, it will impact the output length in your technical Data Extension. 4 characters will be no longer enough. 22, however, will work like a charm."),(0,i.kt)("h2",{id:"fully-fledged-long-term-solution"},"Fully-fledged Long Term Solution"),(0,i.kt)("p",null,"After applying both of the above options to the ",(0,i.kt)("a",{parentName:"p",href:"#basic-long-term-solution"},"Basic SQL Snippet"),", it looks like this:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n      c.Id AS ContactID\n    , CASE\n        WHEN 18 - LEN(c.Id) < 0\n        THEN CONCAT(LEN(c.Id), '(', LEN(c.Id) - 18, ' over limit)')\n      END AS SubscriberKey\n    , CASE\n        WHEN 40 - LEN(c.FirstName) < 0\n        THEN CONCAT(LEN(c.FirstName), '(', LEN(c.FirstName) - 40, ' over limit)')\n      END AS FirstName\n    , CASE\n        WHEN 80 - LEN(c.LastName) < 0\n        THEN CONCAT(LEN(c.LastName), '(', LEN(c.LastName) - 80, ' over limit)')\n      END AS LastName\n    , CASE\n        WHEN 254 - LEN(c.Email) < 0\n        THEN CONCAT(LEN(c.Email), '(', LEN(c.Email) - 254, ' over limit)')\n      END AS EmailAddress\n    , CASE\n        WHEN 80 - LEN(c.JobTitle__c) < 0\n        THEN CONCAT(LEN(c.JobTitle__c), '(', LEN(c.JobTitle__c) - 80, ' over limit)')\n      END AS JobTitle\n    , CASE\n        WHEN 40 - LEN(c.Industry__c) < 0\n        THEN CONCAT(LEN(c.Industry__c), '(', LEN(c.Industry__c) - 40, ' over limit)')\n      END AS Industry\nFROM Contact_Salesforce AS c\nWHERE\n    18 - LEN(c.Id) < 0\n    OR 40 - LEN(c.FirstName) < 0\n    OR 80 - LEN(c.LastName) < 0\n    OR 254 - LEN(c.Email) < 0\n    OR 80 - LEN(c.JobTitle__c) < 0\n    OR 40 - LEN(c.Industry__c) < 0\n")))}h.isMDXComponent=!0}}]);