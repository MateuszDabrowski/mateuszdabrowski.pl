---
id: mcp-serverside-code-context
title: MCP Serverside Code Context
sidebar_label: Serverside Code Context
description: "Context is king. Also when writing MCP Template Serverside Code."
image: img/og/og-image-mcp-serverside-code-context.png
tags: [Marketing Cloud, Marketing Cloud Personalization, Interaction Studio, Personalisation, TypeScript]
---

import { LeadText } from '../../src/components/LeadText.js';

<LeadText content="Context is king. Also when coding MCP Campaign Templates. Read about all its undocumented tricks." />

Marketing Cloud Personalization offers a flexible campaing template creation tooling with multiple [properties](./mcp-serverside-code-properties.mdx) and imports that helps you fulfil the business needs with a nice user experience for the marketer. There is also one more - undocumented - feature that can change your template from good to outstanding. The CampaignComponentContext object.

:::note You Should Know

In this article I'm covering the main `CampaignComponentContext` object that is being passed as a `context` argument to the [`run` method](./mcp-serverside-code-basics.mdx#writing-serverside-code) in the Serverside Code of every campaign template.

There are some other contexts (like `GearLifecycleContext` passed to search methods), that have different structure and are out of the scope of this article.

:::

The `CampaignComponentContext` object is available in the Serverside Code of the Web, Serverside and Triggered Campaign Templates and provides extensive details about triggering event, user and delivered experience.

```js title="Structure of the context object"
{
    "campaignId": string,
    "experienceId": string,
    "userGroup": string,
    "beaconVersion": number,
    "event": Object,
    "contentZone": string,
    "trigger": Object,
    "locale": string,
    "services": Object,
    "user": Object,
    "accountId": string,
    "datasetId": string,
    "configuration": Object
}
```

It's extremely easy to use once you know what's in there. For example, you can pull product ID stored with Sitemap in a User Attribute and leverage it to pull full data about that product for personalization:

```ts {2-3} title="Leverage context in the run method of your Serverside Code"
    run(context: CampaignComponentContext) {
        let lastAddedToCartProductId = context.user.attributes?.lastAddedToCartProduct?.value;
        let lastAddedToCartProductDetails = context.services.catalog.findItem('Product', lastAddedToCartProductId);
        return { lastATCDetails: lastAddedToCartProductDetails };
    }
```

And that's just a basic usage. The key to unlocking the power of context object is knowing what is stored there and how it can be used. So let's dive in, property by property (hint, the fun part starts at [`event`](#event)).

:::note You Should Know

This article is in a work in progress state - I'm ongoingly extending details about various parts of the context object as I have opportunity to use it in real-life.

:::

## campaignId & experienceId

First two string properties of the context object are `campaignId` and `experienceId` and their purpose if very strightforward. They provide the five character, case sensitive, alphanumerical ids for the campaign and experience selected for a user (for example, `vALdQ` for Campaign ID and `f3WpK` for Experience Id).

Both those values are passed by default from serverside to clientside and handlebars (as `campaign` and `experience` accordingly) so there is no much added value in those two unless you want to append those values as query strings to the links for tracking purposes.

However, for Web Campaigns you can do it easily within the handlebars tab and for Serverside and Triggered Campaigns - do it on the receiving system side.

## userGroup

`userGroup` string property should tell you to which user group the user got assigned. Well, should. In practice you will see there one of the two values: `Test` for users that got an A/B Test or Rule-Based experience and `testUserGroup` for those that are in Control group (or in Template preview pane within MCP UI).

However, you will see better values in the out-of-the-box serverside payload `userGroup` property that shows values like `Test`, `Default`, `Control` correctly and only displays `testUserGroup` during preview.

:::note You Should Know

Control group creates more problems for the context, as it returns the payload preview version of it. So you will also see only the placeholder values for [`campaignId` and `experienceId`](#campaignid--experienceid), [`beaconVersion`](#beaconVersion) and skip other datapoints like [`event.fields`](#event).

In short, don't use `context` for custom payload dedicated to control group users.

:::

## beaconVersion

`beaconVersion` number property will display current Web SDK version (f.e. `16` at the moment of writing it) or `0` for preview/control group. Not really useful.

## event

`event` object property is where the magic of the `context` object starts. //TODO

```js title="Structure of the context.event object"
{
    "time": datetime,
    "fields": Object,
    "ipAddress": (): string,
    "itemId": (): string,
    "itemType": (): string
}
```

### event.fields

```js title="Structure of the context.event.fields object"
{
    ".anonId": string,
    ".bv": string,
    ".pv": boolean,
    ".scv": number,
    ".skipProcessing": boolean,
    "action": string,
    "channel": string,
    "clientIp": string,
    "contentZones": string[],
    "pageType": string,
    "url": string,
    "urlref": string,
    "userAgent": string,
    "_anon": boolean,
    "_debug": boolean,
    "customAttribute1": any,
    "customAttribute2": any
}
```

## contentZone

`contentZone` string property returns the Content Zone that was selected for the Campaign. It might be useful if your campaign supports multiple content zones and you want to alter some payload elements based on the one selected (f.e. change the number of returned recommenations):

```ts {2} title="Leverage context.contentZone to change the serverside payload"
// Limit the number of recommendations to first four for smaller placements
if (['search_see-more', 'listing_see-more'].includes(context.contentZone)) {
    recommenations = recommendations.slice(0,4);
}
```


## trigger

`trigger` object property is available only for the Triggered Campaign Templates. //TODO

## locale

If you have switched on Locale support in your Marketing Cloud Personalization, `locale` string will return a five-characters long combination of ISO language code and ISO country code (`language_COUNTRY`, for example: `en_US` for american english).

You can use it to return the campaign content based on the most recent user locale (be it based on manually entered variations in the Campaign configuration or by pulling directly from the localized Catalog):

```ts {6} title="Leverage context.locale to pull localized product details"
const recommendedIds = recommendIdsOnly(context, recipeConfig);
let localisedRecommendations = context.services.catalog
    .findItems('Product', recommendedIds)
    .map(product => product.toFlatJSON(
        ['id', 'name,' 'imageUrl', 'url', 'price'],
        context.locale || ''
    ))
```

## services

```js title="Structure of the context.services object"
{
    "catalog": Object,
    "recommendations": Object,
    "smartTrends": Object,
    "surveys": Object,
    "decisions": Object,
    "corvus": Object,
    "promotionCatalog": Object
}
```

### services.catalog

```js title="Structure of the context.services.catalog object"
{
    "dimensionFilter": (dimension: string): ItemFilter<any>,
    "findClosestItems": (request: ClosestItemsRequest): Item[],
    "findItem": (type: string, id: string): Item,
    "findItems": (type: string, ids: string[]): Item[] || (type: ItemFilter<any>, ids: ItemSort<any>): Item[] || (type: ItemFilter<any>): Item[]
}
```

### services.recommendations


```js title="Structure of the context.services.recommendations object"
{
    "recommend": (request: RecommendationsRequest): Item[],
    "recommendIdsOnly":  (request: RecommendationsRequest): Item[],
    "smartSearch": (request: SmartSearchRequest): Item[],
    "smartSort": (request: SmartSort): Item[]
}
```

### services.smartTrends

```js title="Structure of the context.services.smartTrends object"
{
     "smartTrends": (request: SmartTrendsRequest): ItemTrends[]
}
```

### services.surveys

```js title="Structure of the context.services.surveys object"
{
     "getSurey": (surveyId: string): Survey
}
```

### services.decisions

```js title="Structure of the context.services.decisions object"
{
     "decide": (request: ContextualBanditRequest): Item[]
}
```

### services.corvus

```js title="Structure of the context.services.corvus object"
{
    "contextualBandit": {
        "decide": (request: ContextualBanditRequest, filter: PromotionFilter): Item[]
    }
}
```

### services.promotionCatalog

```js title="Structure of the context.services.promotionCatalog object"
{
    "findPromotions": (filter: ItemFilter<any>, context: CampaignComponentContext): Promotion: [],
    "promotionFilter": (contentZone: string): PromotionFilter
}
```

## user


```js title="Structure of the context.user object"
{
    "attributes": Object,
    "profileObjects": Object,
    "visits": [Object],
    "orderHistory": [Object],
    "location": Object,
    "currentCart": Object,
    "anonymous": boolean,
    "segmentMembership": [Object],
    "id": string,
    actionCount: (request: ActionStatsRequest): number, // {actionName: 'Action Name'}
    actionCountPerItem:  (request: ActionStatsRequest): number, // {actionName: 'Action Name'}
    getDimensionActivity: (dimension: string, start: Date, end: Date): {
        [itemId: string]: ItemActionStats
    }, // 'Product', new Date('2023-08-23T23:30:58.937Z'), new Date('2023-08-24T08:30:58.937Z')
    getDimensionActivityByDay: (dimension: string, start: Date, end: Date): {
        [date: string] : ItemActionStats
    },
    getEmailSendHistory: (start: Date, end: Date): EmailSendActivity[] || (): EmailSendActivity[],
    getLatestOrderByStatus: (status: 'Open' | 'Purchased' | 'Cancelled'): Order,
    getSegmentJoinDate: (segmentId: string): Date,
    itemStatTotal: (request: ItemStatsRequest): number, // (itemId?: string, itemType: string, statType: ItemStatType)
    itemStatTotalPerItem: (request: ItemStatsRequest): ItemStat[], // (itemId?: string, itemType: string, statType: ItemStatType)
    pageViewCount: (request: StatsRequest): number, // {start: Date, end: Date}
    visitCount: (request: StatsRequest): number, // {start: Date, end: Date}
    visitDurationMillis: (request: StatsRequest): number, // {start: Date, end: Date}
}
```

### user.attributes

```js title="Structure of the context.user.attributes object"
{
    "created": {
        "value": number // epoch
    },
    "customAttribute": {
        "value": any
    },
    "originatingReferrer": {
        "value": "{\"medium\":\"Direct\",\"source\":null,\"terms\":null,\"domain\":null,\"subdomainReversed\":null,\"url\":null,\"landingUrl\":\"https://www.mateuszdabrowski.pl/\"}"
    },
    "firstName": {
        "value": string
    },
    "lastViewedCartAt": {
        "value": number // epoch
    },
    "firstActivity": {
        "value": number // epoch
    }
}
```

### user.profileObjects

```js title="Structure of the context.user.attributes object"
{

}
```

### user.visits

```js title="Structure of the context.user.visits array"
[
    {
        "start": number, // epoch
        "lastEventTime": number, // epoch
        "timeSinceLastVisit": number, // miliseconds
        "referrer": { // || null
            "medium": "Direct",
            "source": null,
            "terms": null,
            "domain": null,
            "subdomainReversed": null,
            "url": null,
            "landingUrl": "https://www.mateuszdabrowski.pl/"
        },
        "deviceType": "Computer",
        "browser": "Chrome",
        "platform": "Web",
        "operatingSystem": "Windows",
        "weather": { // || null
            "temperature": 71,
            "humidity": 67,
            "windSpeed": 7,
            "rain3h": 0,
            "snow3h": 0,
            "cloudCoverage": 0,
            "condition": {
                "id": 800,
                "name": "clear sky",
                "icon": "01d",
                "category": "Clear"
            }
        },
        "pageViewIndex": 9
    }
]
```

### user.orderHistory

```js title="Structure of the context.user.orderHistory array"
[
     {
        "id": null,
        "created": number, // epoch
        "updated": number, // epoch
        "purchaseDate": null,
        "visitAgeAtPurchase": number, // miliseconds
        "totalValue": number,
        "totalValueCurrency": null,
        "status": "Open",
        "metadata": null,
        "lineItems": [
            {
                "quantity": number,
                "price": number,
                "itemId": string,
                "attributes": {}
            },
        ],
        "attributes": {}
    }
]
```

### user.location

```js title="Structure of the context.user.location object"
{
    "geographicPoint": {
        "latitude": number,
        "longitude": number
    },
    "timeZoneId": "Europe/Warsaw",
    "continentKey": "EU",
    "countryCode": "PL",
    "countryNumericCode": 616,
    "stateProvinceCode": "14",
    "city": "Warsaw",
    "postalCode": "00-633",
    "organization": "Pwc Polska Sp. Z O.o.",
    "naicsCode": "517311"
}
```

### user.currentCart

```js title="Structure of the context.user.currentCart object"
{
    "id": null,
    "created": number, // epoch
    "updated": number, // epoch
    "purchaseDate": null,
    "visitAgeAtPurchase": number, // miliseconds
    "totalValue": number,
    "totalValueCurrency": null,
    "status": "Open",
    "metadata": null,
    "lineItems": [
        {
            "quantity": number,
            "price": number,
            "itemId": string,
            "attributes": {}
        },
    ],
    "attributes": {}
}
```

### user.segmentMembership

```js title="Structure of the context.user.segmentMembership array"
[
     {
        "segmentId": string,
        "segmentName": string,
        "joined": number, // epoch
        "createIfMissing": boolean,
        "removal": boolean,
        "userId": string,
        "customerId": string,
        "customerType": "User"
    }
]
```

## accountId & datasetId

`accountId` and `datasetId` are string properties that contain information about the Marketing Cloud Personalization account and dataset that generated the event. Not really useful, unless you want environment aware debug log visibility logic.

## configuration

`configuration` object property contains information about the campaign properties (fields you expect marketer to fill in when configuring the campaign) in the experience for a given user. Not really useful, as in the serverside code you can access the same information using `this` keyword (f.e. `this.campaignPropertyName`).